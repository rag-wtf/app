# Story 1.7: Personalized Knowledge Base

**Status**: Draft

## Story

As a user, I want the system to learn from my interactions, so that it can provide faster and more tailored answers over time.

## Acceptance Criteria

1.  A mechanism to store and retrieve user interaction data (e.g., queries, clicked/liked results) is implemented.
2.  The retrieval process is enhanced to use this personalized data to boost relevant documents.
3.  The evaluation framework can track and display query latency and user satisfaction metrics over time.
4.  The core RAG functionality works correctly for new users with no interaction history.

## Dev Notes

*   **Data Model**: A new data model, `UserInteraction`, should be created in the `packages/database` to store user feedback. It should include fields like `userId`, `query`, `documentId`, `timestamp`, and `satisfactionScore`. [Source: `architecture.md#Component Architecture`]
*   **Personalization Service**: A new service, `PersonalizationService`, should be created in `packages/chat/lib/src/services/`. This service will be responsible for saving user interactions and retrieving a personalized document ranking for a given query.
*   **Database Integration**: The `PersonalizationService` will interact with the database through the repository interface defined in the `chat` package. The concrete implementation will be in the `database` package, following the existing platform-specific abstraction pattern. [Source: `architecture.md#Component Architecture`]
*   **ChatService Logic**: The `ChatService` will be modified. Before the standard retrieval process, it will call the `PersonalizationService` to get a list of potentially relevant documents based on the user's history. These documents can be used to augment or re-rank the results from the main retrieval step.
*   **Evaluation Metrics**: The `EvaluationViewModel` will be updated to fetch and display new metrics. This will likely involve new methods in the `ChatService` or a new service to calculate and expose these long-term metrics.

### Testing
*   **Test file location**: All new tests should be placed in the `test/` directory of their respective packages.
*   **Test standards**: Follow existing testing patterns and conventions.
*   **Frameworks**: Use the existing `flutter_test` and `mockito` frameworks.
*   **Requirements**: Unit tests must be written for the new `PersonalizationService` and the updated `ChatService` logic. Tests should cover the scenario for users with and without interaction history.

## Tasks / Subtasks

1.  **Data Model & Database**
    *   [ ] (AC: 1) Define the `UserInteraction` data model in `packages/database`.
    *   [ ] (AC: 1) Update the database repository in the `database` package to include methods for saving and retrieving `UserInteraction` data.
2.  **Personalization Service (`PersonalizationService`)**
    *   [ ] (AC: 1) Create the new `PersonalizationService` in `packages/chat/lib/src/services/`.
    *   [ ] (AC: 1) Implement a method to save user interactions.
    *   [ ] (AC: 2) Implement a method to retrieve personalized document suggestions based on user history.
3.  **Chat Service (`ChatService`)**
    *   [ ] (AC: 2) Inject the `PersonalizationService` into the `ChatService`.
    *   [ ] (AC: 2) Modify the `_rag` method to call the `PersonalizationService` and incorporate its results into the retrieval process.
    *   [ ] (AC: 4) Ensure the logic gracefully handles users with no prior interaction history.
4.  **Evaluation Framework (`EvaluationView` and `EvaluationViewModel`)**
    *   [ ] (AC: 3) Implement the logic to calculate and display query latency and user satisfaction metrics.
5.  **Testing**
    *   [ ] (AC: 1, 2) Write unit tests for the `PersonalizationService`.
    *   [ ] (AC: 2, 4) Write unit tests for the `ChatService` to verify the personalization logic.
    *   [ ] (AC: 3) Write widget tests for the `EvaluationView` to verify the new metrics are displayed.
