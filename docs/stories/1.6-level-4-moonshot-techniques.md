# Story 1.6: Level 4 - "Moonshot" Techniques

**Status**: Draft

## Story

As a user, I want the system to use state-of-the-art techniques like Contextual Enrichment and HyDE, so that the answers are even more precise and contextually aware.

## Acceptance Criteria

1.  Contextual Enrichment is added to the ingestion process.
2.  Hypothetical Answer Search (HyDE) is implemented as a retrieval strategy.
3.  This pipeline can be selected as "Level 4 - Moonshot" in the `SettingsView`.
4.  The evaluation framework can A/B test these techniques against the Advanced RAG pipeline.
5.  The Advanced RAG pipeline can still be used for comparison.

## Dev Notes

*   **Contextual Enrichment**: This will be implemented in the `DocumentApiService` in the `document` package. After the document is processed by Docling and split into chunks, each chunk will be enriched with additional context. This can be achieved by using a separate LLM call to summarize the chunk or extract key entities. [Source: `prd.md#Should Have`]
*   **Hypothetical Answer Search (HyDE)**: This will be implemented in the `ChatService` in the `chat` package. When a user asks a question, a separate LLM call will be made to generate a hypothetical answer. This hypothetical answer will then be used to perform a vector search, which should retrieve more relevant document chunks. [Source: `prd.md#Should Have`]
*   **ChatService Logic**: The `_rag` method in `ChatService` will have a new case for "Level 4". This case will:
    1.  Generate a hypothetical answer using an LLM.
    2.  Use the hypothetical answer to perform a vector search.
    3.  Use the retrieved chunks as the context for the final prompt.
*   **Configuration**: The `SettingService` will need to be updated to manage any new configurations required for these techniques, such as the LLM used for contextual enrichment or HyDE.

### Testing
*   **Test file location**: All new tests should be placed in the `test/` directory of their respective packages.
*   **Test standards**: Follow existing testing patterns and conventions.
*   **Frameworks**: Use the existing `flutter_test` and `mockito` frameworks.
*   **Requirements**: Unit tests must be written for the updated `DocumentApiService` and `ChatService` logic.

## Tasks / Subtasks

1.  **Settings (`SettingsView` and `SettingService`)**
    *   [ ] (AC: 3) Add "Level 4 - Moonshot" as an option to the RAG pipeline level selector.
    *   [ ] (AC: 1, 2) Add any new settings required for Contextual Enrichment and HyDE.
2.  **Document Service (`DocumentApiService`)**
    *   [ ] (AC: 1) In the `_processFile` method, after splitting the document into chunks, add a step to perform contextual enrichment on each chunk.
3.  **Chat Service (`ChatService`)**
    *   [ ] (AC: 2) In the `_rag` method, add a case for "Level 4".
    *   [ ] (AC: 2) In the "Level 4" case, generate a hypothetical answer to the user's question.
    *   [ ] (AC: 2) Use the hypothetical answer to perform a vector search.
    *   [ ] (AC: 2) Use the retrieved chunks to build the prompt context.
4.  **Evaluation Framework (`EvaluationView` and `EvaluationViewModel`)**
    *   [ ] (AC: 4) Implement the logic to A/B test this level against the Advanced RAG pipeline.
5.  **Testing**
    *   [ ] (AC: 1) Write unit tests for the `DocumentApiService` to verify the contextual enrichment logic.
    *   [ ] (AC: 2, 3, 5) Write unit tests for the `ChatService` to verify the HyDE logic.
    *   [ ] (AC: 4) Write widget tests for the `EvaluationView` to verify the A/B testing functionality.
