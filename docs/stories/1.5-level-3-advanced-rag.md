# Story 1.5: Level 3 - Advanced RAG

**Status**: Draft

## Story

As a user, I want the system to use advanced techniques like Hybrid Search and a Re-ranker, so that I get more accurate and relevant answers.

## Acceptance Criteria

1.  A Hybrid Search (combining vector and lexical search) is implemented.
2.  A Re-ranker is added to the retrieval process to improve context quality.
3.  This pipeline can be selected as "Level 3 - Advanced RAG" in the `SettingsView`.
4.  The evaluation framework can measure the impact of these techniques on metrics like nDCG and Context Precision.
5.  The Standard RAG pipeline can still be used for comparison.

## Dev Notes

*   **Hybrid Search**: This will be implemented by combining the results of both the vector search (`similaritySearch`) and the lexical search (`lexicalSearch`) from the `EmbeddingRepository`. A simple approach is to run both searches and merge the results, removing duplicates.
*   **Re-ranker API**: The `architecture.md` specifies using the Cohere API for re-ranking. A new service, `RerankerApiService`, should be created to handle the communication with the Cohere API.
*   **ChatService Logic**: The `_rag` method in `ChatService` will have a new case for "Level 3". This case will:
    1.  Perform the hybrid search.
    2.  Take the combined search results and send them to the `RerankerApiService`.
    3.  Use the re-ranked results as the context for the prompt.
*   **Configuration**: The `SettingService` will need to store the API key for the Cohere API.

### Testing
*   **Test file location**: All new tests should be placed in the `test/` directory of their respective packages.
*   **Test standards**: Follow existing testing patterns and conventions.
*   **Frameworks**: Use the existing `flutter_test` and `mockito` frameworks.
*   **Requirements**: Unit tests must be written for the new `RerankerApiService` and the updated `ChatService` logic for hybrid search and re-ranking.

## Tasks / Subtasks

1.  **Settings (`SettingsView` and `SettingService`)**
    *   [ ] (AC: 3) Add "Level 3 - Advanced RAG" as an option to the RAG pipeline level selector.
    *   [ ] (AC: 2) Add a new setting for the Cohere API key.
2.  **API Service (`RerankerApiService`)**
    *   [ ] (AC: 2) Create a new `RerankerApiService` in `packages/chat/lib/src/services/`.
    *   [ ] (AC: 2) Implement a method in the service to call the Cohere re-ranker API endpoint.
3.  **Chat Service (`ChatService`)**
    *   [ ] (AC: 1, 2) In the `_rag` method, add a case for "Level 3".
    *   [ ] (AC: 1) In the "Level 3" case, call both `similaritySearch` and `lexicalSearch` and merge the results.
    *   [ ] (AC: 2) After the hybrid search, call the `RerankerApiService` with the search results.
    *   [ ] (AC: 2) Use the re-ranked results to build the prompt context.
4.  **Evaluation Framework (`EvaluationView` and `EvaluationViewModel`)**
    *   [ ] (AC: 4) Implement the logic to calculate and display the new metrics (nDCG, Context Precision) for this level.
5.  **Testing**
    *   [ ] (AC: 2) Write unit tests for the `RerankerApiService`.
    *   [ ] (AC: 1, 2, 3, 5) Write unit tests for the `ChatService` to verify the hybrid search and re-ranking logic.
    *   [ ] (AC: 4) Write widget tests for the `EvaluationView` to verify the new metrics are displayed.
