# Story 1.2: Level 0 - Short-Document Bypass with Document Selection

**Status**: Draft

## Story

As a user, I want to select specific documents to chat with, and have the system bypass the RAG pipeline if the total size of the selected documents is small enough to fit in the context window.

## Acceptance Criteria

1.  The document view allows for multiple documents to be selected. By default, all documents are selected.
2.  When the total size of the **selected** documents is below a configurable threshold, the entire content of the selected documents is "stuffed" into the prompt.
3.  The evaluation framework can measure and display metrics for this level (Correctness, Speed, etc.).
4.  The standard RAG pipeline is not affected when the bypass is not triggered.
5.  If the bypass is not triggered, the RAG pipeline should only search within the selected documents.
6.  If no documents are selected, the chat input area should be disabled and a message prompting the user to select a document should be displayed.

## Dev Notes

*   **UI Change**: The `DocumentView` (or equivalent view that lists documents) must be updated to support multiple selections (e.g., using checkboxes).
*   **State Management**: The `DocumentService` should be updated to manage the state of selected documents. A new property, `selectedDocuments`, could be added.
*   **Bypass Logic**: The bypass logic in `packages/chat/lib/src/services/chat_service.dart` (`_rag` method) must be updated to use the list of selected documents from `DocumentService`.
*   **Threshold Configuration**: A new setting, `llmContextWindowSize`, will be added to the settings. This will be used as the threshold for the bypass.
*   **RAG Pipeline Update**: The `ChatService._retrieve` method must be updated to only search within the embeddings of the selected documents. This will likely require passing the list of selected document IDs to the `similaritySearch` method.

### UI/UX and Accessibility Notes
*   **Styling**: The new checkboxes and any related UI elements should conform to the existing application design system and style guide.
*   **Responsiveness**: The document selection feature must be responsive and function correctly on all supported screen sizes.
*   **Accessibility**: The checkboxes must be accessible, with proper labels for screen readers.

### Testing
*   **Test file location**: All new tests should be placed in the `test/` directory of their respective packages.
*   **Test standards**: Follow existing testing patterns and conventions.
*   **Frameworks**: Use the existing `flutter_test` and `mockito` frameworks.
*   **Requirements**: Unit and widget tests must be written for all new UI, state management, and service logic.

## Tasks / Subtasks

1.  **UI (Document View)**
    *   [ ] (AC: 1) Modify the document list view to include checkboxes for each document.
    *   [ ] (AC: 1) Implement the logic to select/deselect documents and update the state in `DocumentService`.
    *   [ ] (AC: 1) Ensure that by default, all documents are selected when the view is loaded.
    *   [ ] (AC: 6) Implement UI changes to disable the chat input and display a message when no documents are selected.
2.  **State Management (DocumentService)**
    *   [ ] (AC: 1) Add a `selectedDocuments` list to `DocumentService`.
    *   [ ] (AC: 1) Add methods to `DocumentService` to manage the selection state (e.g., `selectDocument`, `deselectDocument`, `selectAllDocuments`).
3.  **Settings**
    *   [ ] (AC: 2) Add a new setting for `llmContextWindowSize` in the `SettingService`.
4.  **Chat Service**
    *   [ ] (AC: 2, 5) In `ChatService._rag`, update the logic to:
        *   [ ] Get the list of `selectedDocuments` from `DocumentService`.
        *   [ ] Calculate the total size of the selected documents.
        *   [ ] If the size is below the `llmContextWindowSize` threshold, stuff the content of the selected documents into the prompt.
        *   [ ] If the size is above the threshold, call the `_retrieve` method, passing the IDs of the selected documents.
    *   [ ] (AC: 5) Update the `_retrieve` method to accept a list of document IDs and pass them to the `similaritySearch` method.
5.  **Database/Repository**
    *   [ ] (AC: 5) Update the `EmbeddingRepository.similaritySearch` method to filter by a list of document IDs.
6.  **Testing**
    *   [ ] (AC: 1, 6) Write widget tests for the new document selection UI.
    *   [ ] (AC: 1) Write unit tests for the updated `DocumentService` state management.
    *   [ ] (AC: 2, 4, 5) Write unit tests for the updated `ChatService._rag` and `_retrieve` methods.
